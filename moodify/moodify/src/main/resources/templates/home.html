<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>IEUM</title>
    <link rel="stylesheet" th:href="@{/css/home.css}" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>


        <script>

            $(document).ready(function() {
                $('#btn').click(function(e) { // id="btn" 버튼 클릭 시
                    e.preventDefault(); // 필수! 기본 폼 제출 막기

                    const inputText = $('#moodInput').val(); // 입력값 가져오기
                    $.ajax({
                        url: '/check/recommendations',
                        type: 'GET',
                        data: { text: inputText }, // 쿼리 파라미터로 전송
                        dataType: 'json',
                        success: function(data) {
                            // Y/N 체크
                            if (data.emotion === 'N' || data.situation === 'N') {
                                openSelectionModalWithEmotions(data.emotions || [], data.situations || []);
                            } else {
                                // 바로 추천 페이지로 넘어가는 경우 → 로딩 표시
                                showLoading();
                                $('#moodForm').submit();
                            }
                        },
                        error: function() {
                            alert('error');
                            console.error('데이터 확인 중 오류 발생');
                        }
                    });
                });
                $('#moodInput').keypress(function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();          // 기본 submit 막기
                        $('#btn').click();           // btn 클릭 이벤트 강제 호출
                    }
                });
                function showLoading() {
                    $('#loadingOverlay').addClass('show');
                }
                $(document).on('submit', '.modal-form', function() {
                    showLoading();
                });

            });


            function openSelectionModal() {

                const modal = document.getElementById('selectionModal');
                if (!modal) {
                    console.warn('selectionModal not found in DOM');
                    return;
                }
                const moodInput = $('#moodInput').val();
                $('#inputText').val(moodInput);
                modal.style.display = 'flex'; // 또는 'block'
                modal.classList.add('open');
            }

            function closeSelectionModal() {
                const modal = document.getElementById('selectionModal');
                if (!modal) {
                    return;
                }

                modal.style.display = 'none';
                modal.classList.remove('open');
            }

            // 모달 외부 클릭으로 닫기 (선택사항)
            document.addEventListener('click', function(e) {
                const modal = document.getElementById('selectionModal');
                if (!modal || !modal.classList.contains('open')) return;
                // .modal-content 내부가 아닌 곳을 클릭하면 닫기
                /*const content = modal.querySelector('.modal-content');
                if (!content.contains(e.target)) closeSelectionModal();*/
            });

            function openSelectionModalWithEmotions(emotionsFromServer, situationsFromServer) {
                const modal = document.getElementById('selectionModal');
                if (!modal) return;

                // 감정 체크박스 초기화
                $('.emotion-checkbox').each(function() {
                    const val = $(this).val();
                    if (emotionsFromServer.includes(val)) {
                        $(this).prop('checked', true);
                        $(this).prop('disabled', false);
                    } else {
                        $(this).prop('checked', false);
                        $(this).prop('disabled', true);
                    }
                });

                // 상황도 같은 방식으로 처리 가능
                $('.situation-checkbox').each(function() {
                    const val = $(this).val();
                    if (situationsFromServer.includes(val)) {
                        $(this).prop('checked', true);
                        $(this).prop('disabled', false);
                    } else {
                        $(this).prop('checked', false);
                        $(this).prop('disabled', true);
                    }
                });

                modal.style.display = 'flex';
                modal.classList.add('open');
            }
            $(function () {
                const maxSituation = 2;
                const $situationInputs = $('input[name="situation"]');
                const $error = $('#situation-error');

                // 에러 메시지 초기화
                function showError(msg) {
                  $error.text(msg);
                }

                function clearError() {
                  $error.text('');
                }

                // 체크 제한
                $situationInputs.on('change', function () {
                  const checkedCount = $situationInputs.filter(':checked').length;

                  if (checkedCount > maxSituation) {
                    this.checked = false;   // 방금 체크한 항목 해제
                    showError('상황은 최대 2개까지 선택할 수 있습니다.');
                    return;
                  }

                  // 0~2개 범위라면 에러 지우기
                  clearError();
                });

                // 제출 시에도 검사
                $('.modal-form').on('submit', function (e) {
                  const checkedCount = $situationInputs.filter(':checked').length;

                  if (checkedCount === 0) {
                    e.preventDefault();
                    showError('상황을 1개 이상 선택해 주세요.');
                  } else if (checkedCount > maxSituation) {
                    e.preventDefault();
                    showError('상황은 최대 2개까지 선택 가능합니다.');
                  } else {
                    clearError();
                  }
                });
              });

        </script>


    </head>
    <body>
    <a href="/" style="text-decoration:none; color:inherit;">
        <header class="header">IEUM</header>
    </a>
    <main class="wrap">
        <section class="panel">
            <h1>오늘의 기분은 어떠신가요?</h1>
            <form method="post" th:action="@{/analyze-and-recommend}" id="moodForm">
                <div class="input-row">
                    <input id="moodInput" class="pill-input" type="text" name="text"
                           placeholder="오늘 하루는 어떠셨나요? (예: ‘면접 망해서 속상해..’)" required />
                    <button type="button" class="submit-btn" aria-label="보내기" id="btn">
                        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                            <path d="M4 12h14m-6-6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </form>
        </section>

    </main>
    <div th:replace="~{fragments/modal :: selectionModal}"></div>
    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-box">
            <div class="loading-spinner"></div>
            <p class="loading-text">추천 곡을 불러오는 중이에요...</p>
        </div>
    </div>

    </body>


</html>
