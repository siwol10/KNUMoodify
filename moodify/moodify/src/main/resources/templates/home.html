<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>IEUM</title>
    <link rel="stylesheet" th:href="@{/css/home.css}" />
    <link rel="icon" type="image/x-icon" th:href="@{/css/images/favicon.ico}" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>


        <script>
            function validateMoodInput(raw) {
              const text = raw.trim();

              if (!text) {
                return "내용을 입력해 주세요.";
              }

              if (text.length < 5) {
                return "조금 더 자세히 입력해 주세요. (5자 이상)";
              }

              if (text.length > 50) {
                return "50자 이내로 입력해 주세요.";
              }

              if (/^\d+$/.test(text)) {
                return "숫자만으로는 감정을 알기 어려워요. 문장으로 입력해 주세요.";
              }

              if (/[A-Za-z]/.test(text)) {
                return "영어 대신 한국어로 입력해 주세요.";
              }

              // 허용: 한글, 숫자, 공백, 기본 문장부호 정도만
              if (!/^[가-힣0-9\s.,!?…]+$/.test(text)) {
                return "특수문자/이모지는 사용할 수 없어요.";
              }

              return null; // 통과
            }

            function showMoodError(msg) {
              $('#mood-error').text(msg);
              $('#moodInput').addClass('input-error');
            }

            function clearMoodError() {
              $('#mood-error').text('');
              $('#moodInput').removeClass('input-error');
            }

            function showLoading() {
                    $('#loadingOverlay').addClass('show');
                }

            $(document).ready(function() {
                $('#btn').click(function(e) {
                    e.preventDefault();

                    const inputText = $('#moodInput').val();
                    // ✅ 1차 유효성 검사
                    const error = validateMoodInput(inputText);
                    if (error) {
                        showMoodError(error);
                        return; // 유효성 실패 → AJAX 안 보냄
                    }
                    clearMoodError();

                    $.ajax({
                        url: '/check/recommendations',
                        type: 'GET',
                        data: { text: inputText },
                        dataType: 'json',
                        success: function(data) {
                            // Y/N 체크
                            if (data.emotion === 'N' || data.situation === 'N') {
                                openSelectionModalWithEmotions(data.emotions || [], data.situations || []);
                            } else {
                                showLoading();
                                $('#moodForm').submit();
                            }
                        },
                        error: function() {
                            alert('error');
                            console.error('데이터 확인 중 오류 발생');
                        }
                    });
                });
                $('#moodInput').keypress(function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        $('#btn').click();
                    }
                });
                 // 입력 중에는 에러 제거
                $('#moodInput').on('input', function () {
                    clearMoodError();
                });
            });

            function openSelectionModal() {
                const modal = document.getElementById('selectionModal');
                if (!modal) {
                    console.warn('selectionModal not found in DOM');
                    return;
                }
                const moodInput = $('#moodInput').val();
                $('#inputText').val(moodInput);
                modal.style.display = 'flex'; // 또는 'block'
                modal.classList.add('open');
            }

            function closeSelectionModal() {
                const modal = document.getElementById('selectionModal');
                if (!modal) {
                    return;
                }

                modal.style.display = 'none';
                modal.classList.remove('open');
            }

            document.addEventListener('click', function(e) {
                const modal = document.getElementById('selectionModal');
                if (!modal || !modal.classList.contains('open')) return;
                // .modal-content
                /*const content = modal.querySelector('.modal-content');
                if (!content.contains(e.target)) closeSelectionModal();*/
            });

            function openSelectionModalWithEmotions(emotionsFromServer, situationsFromServer) {
                const modal = document.getElementById('selectionModal');
                if (!modal) return;

                // 감정 체크박스 초기화
                $('.emotion-checkbox').each(function() {
                    const val = $(this).val();
                    if (emotionsFromServer.includes(val)) {
                        $(this).prop('checked', true);
                        $(this).prop('disabled', false);
                    } else {
                        $(this).prop('checked', false);
                        $(this).prop('disabled', true);
                    }
                });

                // 상황 체크박스 초기화
                $('.situation-checkbox').each(function() {
                    const val = $(this).val();
                    if (situationsFromServer.includes(val)) {
                        $(this).prop('checked', true);
                        $(this).prop('disabled', false);
                    } else {
                        $(this).prop('checked', false);
                        $(this).prop('disabled', true);
                    }
                });

                modal.style.display = 'flex';
                modal.classList.add('open');
            }
            $(function () {
                const maxSituation = 2;
                const $situationInputs = $('input[name="situation"]');
                const $error = $('#situation-error');

                function showError(msg) {
                  $error.text(msg);
                }

                function clearError() {
                  $error.text('');
                }

                $situationInputs.on('change', function () {
                  const checkedCount = $situationInputs.filter(':checked').length;

                  if (checkedCount > maxSituation) {
                    this.checked = false;
                    showError('상황은 최대 2개까지 선택할 수 있습니다.');
                    return;
                  }
                  clearError();
                });

                $('.modal-form').on('submit', function (e) {
                    const checkedCount = $situationInputs.filter(':checked').length;

                    if (checkedCount === 0) {
                      e.preventDefault();
                      showError('상황을 1개 이상 선택해 주세요.');
                      return;
                    }

                    if (checkedCount > maxSituation) {
                      e.preventDefault();
                      showError('상황은 최대 2개까지 선택 가능합니다.');
                      return;
                    }

                    clearError();
                    showLoading();
                  });
              });

        </script>


    </head>
    <body>
    <a href="/" style="text-decoration:none; color:inherit;">
        <header class="header">IEUM</header>
    </a>
    <main class="wrap">
        <section class="panel">
            <h1>오늘의 기분은 어떠신가요?</h1>
            <form method="post" th:action="@{/analyze-and-recommend}" id="moodForm">
                <div class="input-row">
                    <input id="moodInput" class="pill-input" type="text" name="text"
                           placeholder="오늘 하루는 어떠셨나요? (예: ‘면접 망해서 속상해..’)" required />
                    <button type="button" class="submit-btn" aria-label="보내기" id="btn">
                        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                            <path d="M4 12h14m-6-6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <p id="mood-error" class="input-error-text"></p>
            </form>
        </section>

    </main>
    <div th:replace="~{fragments/modal :: selectionModal}"></div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-box">
            <div class="loading-spinner"></div>
            <p class="loading-text">추천 곡을 불러오는 중이에요...</p>
        </div>
    </div>

    </body>


</html>
